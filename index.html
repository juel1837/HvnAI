<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HvnChat - AI Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            height: 100dvh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        @media (max-width: 1024px) {
            .sidebar-mobile {
                position: absolute;
                z-index: 40;
                height: 100%;
                transform: translateX(-100%);
            }
            .sidebar-mobile.open {
                transform: translateX(0);
            }
        }
        .glass { background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="flex flex-1 overflow-hidden relative">
        
        <aside id="sidebar" class="sidebar-mobile lg:relative w-72 bg-gray-800 border-r border-gray-700 flex flex-col shrink-0 sidebar-transition">
            <div class="p-4 flex items-center justify-between">
                <span class="font-bold text-xl text-blue-400">HvnChat</span>
                <button onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-white">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <div class="px-4 mb-4">
                <button onclick="createNewProject()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-4 rounded-xl flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg">
                    <i data-lucide="plus" class="w-5 h-5"></i> New Project
                </button>
            </div>
            
            <div id="projectList" class="flex-1 overflow-y-auto px-4 space-y-2 pb-4">
                </div>

            <div class="p-4 border-t border-gray-700 bg-gray-800/50">
                <button onclick="toggleSettings()" class="flex items-center gap-2 text-gray-400 hover:text-white hover:bg-gray-700 p-2 rounded-lg transition-all w-full">
                    <i data-lucide="settings" class="w-5 h-5"></i> Settings
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-gray-900">
            <header class="h-16 border-b border-gray-700 flex items-center justify-between px-4 bg-gray-800/30">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-700 rounded-lg lg:hidden transition">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <div class="hidden sm:flex gap-1.5">
                        <div class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.5)]"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-500 shadow-[0_0_8px_rgba(234,179,8,0.5)]"></div>
                        <div class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)]"></div>
                    </div>
                </div>

                <div class="flex items-center gap-1 bg-gray-950/50 p-1 rounded-xl border border-gray-700">
                    <button onclick="setView('preview')" id="btnPreview" class="px-4 py-1.5 rounded-lg bg-blue-600 text-sm font-semibold transition-all">Preview</button>
                    <button onclick="setView('code')" id="btnCode" class="px-4 py-1.5 rounded-lg hover:bg-gray-800 text-sm font-semibold transition-all">Code</button>
                </div>

                <button onclick="downloadCode()" class="p-2 hover:bg-gray-700 rounded-full transition-all text-blue-400" title="Download HTML">
                    <i data-lucide="download" class="w-5 h-5"></i>
                </button>
            </header>

            <div class="flex-1 relative bg-white overflow-hidden">
                <iframe id="previewFrame" class="w-full h-full"></iframe>
                <div id="codeEditor" class="absolute inset-0 bg-[#0d1117] hidden">
                    <textarea id="rawCode" class="w-full h-full p-6 font-mono text-sm bg-transparent text-blue-300 outline-none resize-none" readonly></textarea>
                </div>
                
                <div id="loader" class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm flex flex-col items-center justify-center hidden z-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mb-4"></div>
                    <p class="text-blue-400 font-medium animate-pulse">HvnChat is coding...</p>
                </div>
            </div>

            <footer class="p-4 border-t border-gray-700 bg-gray-800/80 shrink-0">
                <div class="max-w-4xl mx-auto flex gap-3">
                    <textarea id="userInput" rows="1" 
                        placeholder="আপনার ওয়েবসাইটের আইডিয়া লিখুন..." 
                        class="flex-1 bg-gray-900 border border-gray-600 rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 resize-none text-white transition-all overflow-hidden"
                        oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
                    
                    <button id="sendBtn" onclick="generateWebsite()" class="bg-blue-600 hover:bg-blue-700 active:scale-95 p-3 rounded-xl transition-all self-end shadow-lg shadow-blue-900/20">
                        <i data-lucide="sparkles" class="w-6 h-6"></i>
                    </button>
                </div>
            </footer>
        </main>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl border border-gray-700 shadow-2xl overflow-hidden">
            <div class="p-6">
                <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <i data-lucide="sliders"></i> Settings
                </h2>
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">API URL</label>
                        <input id="apiUrl" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">OpenRouter API Key</label>
                        <input id="apiKey" type="password" placeholder="sk-or-..." class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">AI Model</label>
                        <input id="modelId" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none transition-all">
                    </div>
                </div>
            </div>
            <div class="bg-gray-900/50 p-4 flex justify-end">
                <button onclick="toggleSettings()" class="bg-blue-600 hover:bg-blue-700 px-8 py-2.5 rounded-xl font-bold transition-all">Save Config</button>
            </div>
        </div>
    </div>

    <script>
        const SYSTEM_PROMPT = "You are a professional web developer. Output ONLY raw, valid, single-file HTML code using Tailwind CSS. Do NOT include any markdown formatting like ```html. Start directly with <!DOCTYPE html>.";
        
        let projects = JSON.parse(localStorage.getItem('hvn_projects') || '[]');
        let currentCode = "";

        lucide.createIcons();

        window.onload = () => {
            document.getElementById('apiUrl').value = localStorage.getItem('apiUrl') || "[https://openrouter.ai/api/v1/chat/completions](https://openrouter.ai/api/v1/chat/completions)";
            document.getElementById('apiKey').value = localStorage.getItem('apiKey') || "";
            document.getElementById('modelId').value = localStorage.getItem('modelId') || "deepseek/deepseek-r1:free";
            renderProjects();
        };

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            if (!modal.classList.contains('hidden')) {
                localStorage.setItem('apiUrl', document.getElementById('apiUrl').value);
                localStorage.setItem('apiKey', document.getElementById('apiKey').value);
                localStorage.setItem('modelId', document.getElementById('modelId').value);
            }
            modal.classList.toggle('hidden');
        }

        function setView(view) {
            const preview = document.getElementById('previewFrame');
            const editor = document.getElementById('codeEditor');
            const btnP = document.getElementById('btnPreview');
            const btnC = document.getElementById('btnCode');

            if (view === 'preview') {
                preview.classList.remove('hidden');
                editor.classList.add('hidden');
                btnP.classList.add('bg-blue-600');
                btnC.classList.remove('bg-blue-600');
            } else {
                preview.classList.add('hidden');
                editor.classList.remove('hidden');
                btnC.classList.add('bg-blue-600');
                btnP.classList.remove('bg-blue-600');
            }
        }

        async function generateWebsite() {
            const prompt = document.getElementById('userInput').value;
            const apiKey = document.getElementById('apiKey').value;
            const apiUrl = document.getElementById('apiUrl').value;
            const model = document.getElementById('modelId').value;

            if (!navigator.onLine) {
                alert("চেক কর! তোর ইন্টারনেট কানেকশন নেই।");
                return;
            }

            if (!apiKey) {
                alert("Settings এ গিয়ে API Key টা দে আগে!");
                toggleSettings();
                return;
            }
            if (!prompt) return;

            showLoader(true);

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href, 
                        'X-Title': 'HvnChat AI'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { role: "user", content: prompt }
                        ]
                    })
                });

                // Anti-Crash JSON Logic
                const text = await response.text();
                
                if (!response.ok) {
                    let errorMessage = "API Error";
                    try {
                        const errJson = JSON.parse(text);
                        errorMessage = errJson.error?.message || text;
                    } catch(e) { errorMessage = text; }
                    
                    alert("ওরে বাবা! সমস্যা হয়েছে: " + errorMessage);
                    showLoader(false);
                    return;
                }

                const data = JSON.parse(text);
                let rawContent = data.choices[0].message.content;
                
                // Clean markdown tags if present
                currentCode = rawContent.replace(/```html|```/g, "").trim();
                
                updateDisplay();
                saveProject(prompt.substring(0, 25), currentCode);
                document.getElementById('userInput').value = "";
                document.getElementById('userInput').style.height = 'auto';

            } catch (error) {
                alert("Network Error: এপিআই এর সাথে যোগাযোগ করা যাচ্ছে না। " + error.message);
            } finally {
                showLoader(false);
                if (window.innerWidth < 1024) toggleSidebar(); 
            }
        }

        function updateDisplay() {
            const iframe = document.getElementById('previewFrame');
            const textarea = document.getElementById('rawCode');
            textarea.value = currentCode;
            
            const blob = new Blob([currentCode], { type: 'text/html' });
            iframe.src = URL.createObjectURL(blob);
        }

        function saveProject(name, code) {
            const project = { id: Date.now(), name, code };
            projects.unshift(project);
            localStorage.setItem('hvn_projects', JSON.stringify(projects));
            renderProjects();
        }

        function deleteProject(id, event) {
            event.stopPropagation();
            if (confirm("কিরে! সত্যি প্রজেক্টটা ডিলিট করে দিবি?")) {
                projects = projects.filter(p => p.id !== id);
                localStorage.setItem('hvn_projects', JSON.stringify(projects));
                renderProjects();
            }
        }

        function renderProjects() {
            const list = document.getElementById('projectList');
            list.innerHTML = projects.map(p => `
                <div onclick="loadProject(${p.id})" class="group flex items-center justify-between p-3 text-sm bg-gray-700/30 hover:bg-gray-700 rounded-xl cursor-pointer transition-all border border-transparent hover:border-gray-600">
                    <span class="truncate pr-2">${p.name}</span>
                    <button onclick="deleteProject(${p.id}, event)" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 transition-all">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function loadProject(id) {
            const project = projects.find(p => p.id === id);
            if (project) {
                currentCode = project.code;
                updateDisplay();
                setView('preview');
                if (window.innerWidth < 1024) toggleSidebar();
            }
        }

        function createNewProject() {
            if (currentCode && !confirm("নতুন প্রজেক্ট শুরু করলে বর্তমান কোড মুছে যাবে। তুই কি শিওর?")) return;
            currentCode = "";
            updateDisplay();
            document.getElementById('userInput').value = "";
            if (window.innerWidth < 1024) toggleSidebar();
        }

        function downloadCode() {
            if (!currentCode) return alert("ডাউনলোড করার মত কিছু আগে বানা!");
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([currentCode], { type: 'text/html' }));
            a.download = 'HvnChat-Project.html';
            a.click();
        }

        function showLoader(show) {
            document.getElementById('loader').classList.toggle('hidden', !show);
            document.getElementById('sendBtn').disabled = show;
        }
    </script>
</body>
</html>
